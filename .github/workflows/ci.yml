name: CI

on: push

jobs:
  webknossos_linux:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]
    defaults:
      run:
        working-directory: webknossos

    steps:
    - uses: actions/checkout@v1
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
        architecture: 'x64'

    - name: Install dependencies
      run: |
        pip install poetry
        poetry install

    - name: Check formatting
      run: poetry run ./format.sh check

    - name: Lint code
      run: poetry run pylint -j4 webknossos

    - name: Check typing
      run: |
        poetry run ./typecheck.sh

    - name: Python tests
      run: poetry run pytest tests

    - name: Check if git is dirty
      run: |
        git diff --no-ext-diff --quiet --exit-code
        [[ -z $(git status -s) ]]

  wkcuber_linux:
    needs: [webknossos_linux]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]
    defaults:
      run:
        working-directory: wkcuber

    steps:
    - uses: actions/checkout@v2

    - uses: marceloprado/has-changed-path@v1
      id: changed
      with:
        paths: "."

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        pip install poetry
        poetry install

    - name: Decompress test data
      run: tar -xzvf testdata/WT1_wkw.tar.gz

    - name: Check formatting
      run: poetry run black --check .
      if: steps.changed.outputs.changed == 'true'

    - name: Lint code
      run: poetry run pylint -j4 wkcuber
      if: steps.changed.outputs.changed == 'true'

    - name: Check typing
      run: |
        ./typecheck.sh
      if: steps.changed.outputs.changed == 'true'

    - name: Python tests
      run: poetry run pytest tests

    - name: CLI tests
      run: tests/scripts/all_tests.sh

    - name: Generate Docs
      if: matrix.python-version == '3.8' 
      run: |
        docs/api.sh --persist

    - name: Push docs (for branch)
      if: startsWith(github.event.ref, 'refs/heads') && matrix.python-version == '3.8'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: "eu-west-1"
      run: |
        CI_BRANCH=${GITHUB_REF##*/}
        NORMALIZED_CI_BRANCH=${CI_BRANCH//[\/-]/_}
        aws s3 sync --acl public-read docs/api s3://static.webknossos.org/lib-docs/${NORMALIZED_CI_BRANCH}

    - name: Push docs (for tag)
      if: startsWith(github.event.ref, 'refs/tags') && matrix.python-version == '3.8'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: "eu-west-1"
      run: |
        CI_TAG=$(git describe --tags)
        aws s3 sync --acl public-read docs/api s3://static.webknossos.org/lib-docs/${CI_TAG}

    - name: Check if git is dirty
      run: |
        git diff --no-ext-diff --quiet --exit-code
        [[ -z $(git status -s) ]]

  wkcuber_win:
    needs: [webknossos_linux]
    # Caution! The Windows VM seems to be running out of storage rather quickly.
    runs-on: windows-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]
    defaults:
      run:
        working-directory: wkcuber

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      shell: bash
      run: |
        pip install poetry
        poetry install

    - name: Decompress test data
      shell: bash
      run: tar -xzvf testdata/WT1_wkw.tar.gz

    - name: Python tests
      shell: bash
      run: poetry run pytest tests

    - name: CLI tests
      shell: bash
      run: tests/scripts/all_tests.sh

  wkcuber_mac:
    needs: [webknossos_linux]
    runs-on: macos-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]
    defaults:
      run:
        working-directory: wkcuber

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        pip install poetry
        poetry install

    - name: Decompress test data
      run: tar -xzvf testdata/WT1_wkw.tar.gz

    - name: Python tests
      run: poetry run pytest tests

    - name: CLI tests
      run: tests/scripts/all_tests.sh

  wkcuber_docker:
    needs: [wkcuber_linux, wkcuber_win, wkcuber_mac]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build docker image
      run: docker build -t scalableminds/webknossos-cuber:$GITHUB_SHA wkcuber

    - name: Smoke test docker
      run: |
        docker run --rm \
          -v$(pwd)/testdata:/app/testdata \
          scalableminds/webknossos-cuber:$GITHUB_SHA \
          wkcuber.cubing \
            --jobs 2 \
            --batch_size 8 \
            --layer_name color \
            --wkw_file_len 32 \
            testdata/tiff testoutput/tiff

    - name: Login to docker
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
      run: |
        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

    - name: Push docker images
      run: |
        docker push scalableminds/webknossos-cuber:$GITHUB_SHA

    - name: Push docker images (for tag)
      if: startsWith(github.event.ref, 'refs/tags')
      run: |
        CI_TAG=$(git describe --tags)
        docker tag \
          scalableminds/webknossos-cuber:$GITHUB_SHA \
          scalableminds/webknossos-cuber:$CI_TAG
        docker push scalableminds/webknossos-cuber:$CI_TAG

    - name: Push docker images (for branch)
      if: startsWith(github.event.ref, 'refs/heads')
      run: |
        CI_BRANCH=${GITHUB_REF##*/}
        NORMALIZED_CI_BRANCH=${CI_BRANCH//[\/-]/_}
        docker tag \
          scalableminds/webknossos-cuber:$GITHUB_SHA \
          scalableminds/webknossos-cuber:$NORMALIZED_CI_BRANCH
        docker push scalableminds/webknossos-cuber:$NORMALIZED_CI_BRANCH
        if [ "${CI_BRANCH}" == "master" ]; then
          docker tag \
            scalableminds/webknossos-cuber:$GITHUB_SHA \
            scalableminds/webknossos-cuber:latest
          docker push scalableminds/webknossos-cuber:latest
        fi

  pypi:
    needs: [webknossos_linux, wkcuber_linux, wkcuber_win, wkcuber_mac]
    if: startsWith(github.event.ref, 'refs/tags')
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v1
      with:
        python-version: 3.8
        architecture: 'x64'
    - name: Install dependencies
      run: pip3 install -r requirements.txt
    - name: Publish python packages
      env:
        PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
        PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: ./publish.sh
