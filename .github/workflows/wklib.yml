name: wklib

on:
  push:
    paths:
      - "wklib/**"

defaults:
  run:
    working-directory: wklib

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7, 3.8]

    steps:
    - uses: actions/checkout@v1
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
        architecture: 'x64'

    - name: Install dependencies
      run: |
        pip install poetry
        poetry install

    - name: Check formatting
      run: poetry run ./format.sh check

    - name: Lint code
      run: poetry run pylint -j4 wklib

    - name: Check typing
      run: |
        poetry run ./typecheck.sh

    - name: Python tests
      run: poetry run pytest tests

    - name: Check if git is dirty
      run: |
        git diff --no-ext-diff --quiet --exit-code
        [[ -z $(git status -s) ]]

    # - name: Publish python package
    #   if: startsWith(github.event.ref, 'refs/tags') && matrix.python-version == '3.7'
    #   env:
    #     PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
    #     PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
    #   run: ./publish.sh
